运行时的`Vue`中是不包含编译器的。编译器的代码量相当庞大因此这里不全部展示源码了，以问题的形式说明一下编译器的作用。

## Vue的编译器做了什么？

1. 模板解析（`paeser`）。将`HTML`解析成`AST`，也就是一个`JS`对象。
2. 优化（`optimize`）。标记静态节点用于生成渲染函数。
3. 生成渲染函数。也就是我们经常说的`render`函数。

下面是源码中的主要流程。

```js
export const createCompiler = createCompilerCreator(function baseCompile (
  template: string,
  options: CompilerOptions
): CompiledResult {
  //解析器根据配置解析模板，生成ast
  const ast = parse(template.trim(), options)
  //优化器标记静态节点
  if (options.optimize !== false) {
    optimize(ast, options)
  }
  //根据ast和对应的配置生成渲染函数
  const code = generate(ast, options)
  return {
    ast,
    render: code.render,
    staticRenderFns: code.staticRenderFns
  }
})
```

## Vue解析HTML模板的过程

1. 首先会遍历整个模板，然后通过正则匹配的方式匹配到`<`。这标志着模板的开始位置。
2. 跳过一些不需要处理的标签，比如说注释标签，文档类型声明标签和条件注释1标签等等。
3. **解析开始标签。**

-  得到一个对象，包括 标签名（tagName）、所有的属性（attrs）、标签在 html 模版字符串中的索引位置 
-  进一步处理上一步得到的 attrs 属性，将其变成 [{ name: attrName, value: attrVal, start: xx, end: xx }, ...] 的形式 
-  通过标签名、属性对象和当前元素的父元素生成 AST 对象，其实就是一个 普通的 JS 对象，通过 key、value 的形式记录了该元素的一些信息 
-  接下来进一步处理开始标签上的一些指令，比如 v-pre、v-for、v-if、v-once，并将处理结果放到 AST 对象上 
-  处理结束将 ast 对象存放到 stack 数组 
-  处理完成后会截断 html 字符串，将已经处理掉的字符串截掉 

1. **解析结束标签。**

-  如果匹配到结束标签，就从 stack 数组中拿出最后一个元素，它和当前匹配到的结束标签是一对。 
-  再次处理开始标签上的属性，这些属性和前面处理的不一样，比如：key、ref、scopedSlot、样式等，并将处理结果放到元素的 AST 对象上 。 

-  然后将当前元素和父元素产生联系，给当前元素的 ast 对象设置 parent 属性，然后将自己放到父元素的 ast 对象的 children 数组中 。

1. `HTML`解析完成，返回抽象语法树`AST`。

上面的两个问题主要针对Vue的编译器的解析阶段。

## 什么是静态节点？

编译器的优化过程就是标记静态节点的过程，因此首先要明白`Vue`的编译器认为什么样的节点才是静态节点。

- 文本节点。
- 非组件。
- 没有`v-bind v-for v-if`指令的节点。

## Vue静态节点标记的过程

- 标记静态节点。

这里会遍历所有的节点并根据上述条件做标记。如何一个节点自己是静态节点，但是遍历子节点后发现子节点存在非静态节点，则该节点也会被标记为非静态节点。

- 标记静态根节点。

节点本身是静态节点，并且有子节点且这些子节点不全是文本节点，则标记为静态根节点。

节点不是静态根节点，则去子节点中寻找静态根节点。

这一部分就是优化的过程，主要掌握如何标记静态根节点。被标记为静态根节点的节点，在后续的更新中会跳过它们，以达到提高性能的目的。

## Vue渲染函数的生成过程？

有了上面解析得到的抽象语法树和优化标记出的静态根节点就可以生成渲染函数了。实际上的渲染函数有两类

- `render`。这个就是我们最常说的渲染函数，负责生成动态节点的`vnode`。
- `staticRenderFns`。负责生成静态节点的渲染函数。

总得来说渲染函数生成其实也是遍历抽象语法树的过程。生成形如`_c(tag, attr, children, normalizationType`的函数，`tag`是标签的名字，`attr`是标签的属性，`children`是标签的子节点的渲染函数，和`_c`函数的形式是一样的。最后这个参数是一个表示规范化类型的参数，不太重要。

### 静态节点如何处理？

- 生成静态节点`vnode`的函数会放到`staticRenderFns`数组中。
- 返回一个`_m(idx)`可执行函数，意思是执行上面那个数组中下标为`idx`的函数，生成静态节点的`v-node`。

### v-once v-if v-for如何处理？

- 单纯的`v-once`本身就和静态节点的处理方式一致。
- `v-if`返回一个三元表达式，决定是否需要生成对应节点的渲染函数。
- `v-for`的处理结果返回一个`_l`函数负责生成包含该指令的节点的`vnode`。





`Vue`的编译器应该是我遇到的目前最难以学习和理解的知识点了，可能这里涉及了大量计算机底层和基础相关的知识，没有学过基础课程啃起来确实相当吃力。

后面补完基础再回来看看吧！