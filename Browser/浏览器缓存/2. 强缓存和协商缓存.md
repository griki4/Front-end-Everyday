## 强缓存和协商缓存

### 强缓存

使用强缓存，在资源的有效期内，直接读取缓存中的资源，不必向服务器发起请求。

在`http`响应头中设置`Expires`或者`Cache-Control`属性可以启用强缓存策略。

#### （1）Expires

服务器在响应头中添加一个`Expires`属性，表示资源的过期时间，主要在`http1.0`中使用。`Expires`中设置的时间是绝对时间，是服务器的时间，因此如果浏览器和服务器的时间不一致，或者用户修改了浏览器的时间，采用`Expires`的强缓存策略就会出现问题。

```
Expires: Sun, 19 Jun 2022 09:50:10 GMT
```

#### （2）Cache-Control

为了解决`Expires`的问题，`http1.1`中提出了新的头部字段`Cache-control`，用于实现对强缓存机制更加精确有效的控制。

```
Cache-Control: max-age=300
```

`Cache-Control`的可选字段有：

- `public`：代表资源可以被任何对象缓存，无论是客户端还是代理服务器。
- `private`：资源只可以被用户浏览器缓存，不允许任何代理服务器缓存。一些包含用户隐私信息的HTML都应该设置该选项。
- `no-cache`：每次都是先和服务器确认资源是否改变再决定是否读取缓存。
- `no-store`：禁止任何缓存，每次请求都是直接向服务器请求资源。（旧时代的残党了属于是）
- `max-age=`：缓存过期时间，注意它记录的是浏览器发送请求与它上一次接受到服务器返回资源之间的时间差，比绝对时间更加精准。
- `s-maxage=`：适用于共享缓存，优先级高于`max-age`
- `max-stale[=]`：客户端愿意接收过期的资源，只要不超过规定的时间限制。

### 协商缓存

协商缓存是强缓存没有命中的时候启用的，首先会创建一个请求发送到服务器来确认资源是否改变，没有改变则返回304，浏览器读取缓存资源，否则向浏览器返回修改后的资源。

在`http`头部设置`Etag`和`Last-Modified`可以启用协商缓存。

#### （1）Last-Modified

`Last-Modifined`的属性是浏览器所请求的资源最后一次发生变换的时间，这是由服务器所记录的。触发协商缓存，浏览器将他接收的资源的`Last-Modified`值放入请求头中的`if-Modified-Since`属性中，服务器对比对应资源的`Last-Modified`，一致则返回304，浏览器去读取本地缓存，否则则返回修改后的资源以及新的`Last-Modified`。

但是`Last-Modified`的精度只能到秒，如果资源在1秒内被连续修改很多次，这个方法就会有问题了。

#### （2）Etag

`Etag`是为了解决`Last-Modified`的精确度不够高的问题而出现的。`Etag`是资源的唯一标识，只要资源改变就会改变，无论是在多短的时间内完成。触发协商缓存，浏览器在请求头中设置`if-None-Match`属性，值为上一次服务器响应资源的`Etag`值，浏览器对比请求头中的`Etag`和对应资源的`Etag`决定返回结果。



如果同时设置`Etag`和`Last-Modified`，`Etag`的优先级更高，主要处于几个方面的考虑。

- 资源周期性修改但是内容不改变，此时我们不希望浏览器认为这个资源该变了
- 某些服务器无法准确获取资源修改的具体时间
- `Last-Modified`对于秒级以上的文件修改速度无法准确判断

这也并不是说`Etag`就是最优解，如果考虑负载均衡使用多个服务器的时候，相同资源在不同服务器上的`Etag`是不同的，此时就最好不要设置`Etag`了。
