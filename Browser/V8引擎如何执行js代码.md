## V8引擎的执行流程

> 尽管`JavaScript`是一门解释型的语言，但是`V8`引擎执行的过程中编译器和解释器都参与了执行。

执行一段`js`代码的基本流程如下：

- 通过词法分析和语法分析生成抽象语法树（`AST`）和执行上下文。
- 解释器根据`AST`生成字节码，并且解释执行。
- 解释器记录执行过程中的热点代码，调用编译器将其编译为机器码，提高执行效率。

类似浏览器需要将`HTML`解析为`DOM`树执行一样，`js`代码也需要解析成抽象语法树才能被`js`引擎执行。

### 生成抽象语法树

#### 词法分析生成`token`

该阶段会将`js`代码拆分成一个个的`token`，也即无法再进行拆分的最小单位。比如这段代码：

```javascript
let name = "Jack"
```

拆分后变为4个`token`，关键字`let`，标识符`name`，赋值语句`=`，以及字符串`Jack`。

#### 语法分析组成AST

根据生成的`token`和语法规则生成`AST`，如果有错误的语法则会报错。成功生成`AST`之后，V8还会为这段代码生成执行上下文。

### 生成字节码

有了`AST`和执行上下文，解释器会上线，将`AST`生成字节码，然后字节码转换为机器码进行执行。看上去有点“多此一举”的行为实际上是V8团队的刻意为之。因为机器码虽然拥有无可匹敌的执行速度，但是代价就是需要占用相当大的存储空间，相比起来字节码占用的空间就小得多，执行的时候由解释器将字节码翻译为机器码执行即可。

这可以看做是一种以时间换空间的策略。

### 执行代码

到此本可以结束代码的执行流程，但是`JIT`（即时编译技术）的出现改变了这一切，它让编译器和解释器可以配合工作。毕竟直接执行机器码的速度还是太诱人了。

利用`JIT`，解释器在执行代码的过程中，会收集**热点代码**。比如那些被反复执行的代码，此时编译器就会参与工作，将这些热点代码编译成为机器码，下一次执行直接调用机器码即可。

得益于`JIT`，也有一句趣言，**V8执行越久，执行效率越高**。





