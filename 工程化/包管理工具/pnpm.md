> 什么年代了还在用传统包管理器！

## 原有包管理工具的痛点

原有包管理工具最大的痛点其实是依赖包无法复用的问题。

一般来说，我们的电脑里面不可能永远只开发一个项目。在开发多个项目的时候，每个项目都拥有自己的依赖包，即`node_modules`目录管理的文件。如果说此时多个项目中都依赖了同一个外部工具包，以`axios`这个常见的工具为例。`A B`两个项目都依赖了`axios`，原有的包管理工具的策略是在`A B`两个项目各自的`node_modules`文件夹下都保存一份`axios`的源码，即使它们完全相同。这无疑就造成了磁盘空间的无意义占用。`npm yarn`等包管理工具都存在这个问题。

`pnpm`则将这些依赖包收集起来统一管理，所有项目都可以访问。这样做无疑大大减小了项目的磁盘占用率。除此之外，`pnpm`还拥有高效、安装速度快等优点。

## 硬连接和软连接

### 硬连接

维基百科定义：**电脑系统中多个文件平等的共享一个文件存储单元**。

电脑中真实的数据都是存储在电脑磁盘中的，而操作系统会对这些数据进行一个抽象和映射。比如我下载了一个视频`xx.mp4`，视频中真实的数据都是存在磁盘中的，而我们在电脑上看见的就是一个名为`xx.mp4`的文件。这个文件和磁盘中对应的数据之间就是建立了硬连接。

以`abc.js`为例，我们在命令行窗口中输入

```
mklink /H abc.js abc_hard.js
```

就能在统计目录看到一个`abc_hard.js`文件。此时我们无论修改哪一个文件，其变化都会反映在另一个文件上。本质是因为，虽然在操作系统中表现为两个文件，但是实际上这两个文件访问的都是磁盘中的同一份数据，所以变化才会反映到彼此身上。

这和`js`中引用数据类型的概念很像。

### 软连接

维基百科定义：**一类特殊的文件，其中包含一条以绝对或者相对路径的形式指向其他文件或目录的引用**。

其实通俗的来说就是电脑上的快捷方式。我们建立快捷方式，就是为了能够快速访问某一个目录下的文件，快捷方式内部仅仅只是一个引用，指向某个文件。**软连接不能进行编辑**。

下面的命令可以建立一个软连接

```
mklink abc_soft.js abc.js
```

可以发现`abc_soft.js`文件左下角有一个箭头，表明它是一个快捷方式，指向某个文件。

## pnpm

### 原理

使用`pnpm`（全程`performant npm`）安转依赖包的时候，`pnpm`会将这些依赖包存放到一个统一的位置。磁盘中此时保存了一份依赖包的数据。

- 若多个项目依赖了同一个版本的依赖包，则会直接在项目和磁盘文件之间建立硬连接，而不是重新下载保存依赖包。这自然比传统的包管理更加高效以及节约磁盘空间。
- 若依赖了同一个依赖包的不同版本。`pnpm`只会保存那些不同版本之间发生了变化的文件，没有变化的文件只会保存一份。

### 非扁平的node_modules目录

扁平化目录？

以`axios`为例，如果使用`npm/yarn`安装`axios`会发现，`node_modules`目录下除了`axios`的文件夹，还有一些`axios`本身依赖的包，并且这些被依赖的包和`axios`出于同一个层级的目录中。这就是扁平化目录。这样我们在项目中就能直接使用`axios`所依赖的包，比如`forndata`，即使我们没有安装它。这样的的做法是不够规范的。因此`pnpm`建立的`node_modules`是非扁平化的，以下图为例。

![img](https://www.pnpm.cn/assets/images/node-modules-structure-8ab301ddaed3b7530858b233f5b3be57.jpg)

项目中依赖了`bar`，那么`node_modules`中只有`bar`这个文件夹。这个文件夹是一个软连接，连接到同级的`.pnpm`目录下的`bar`文件，这个文件就是一个硬连接，连接到磁盘中的数据。而当`bar`中依赖了其他比如`foo`这个库的时候，会在`bar`的`node_modules`目录下又建立一个软连接，连接到`.pnpm`下的`foo`文件，里面的硬连接会指向磁盘中存储了`foo`数据的位置。

这样做，即使`bar`这个库依赖了`foo`这个库，我们也不能直接在项目中使用`foo`而必须重新安装。增加了目录结构的复杂度但是规范了依赖库的使用。

### 常见命令

| npm                 | pnpm              |
| ------------------- | ----------------- |
| npm install         | pnpm install      |
| npm install <pkg>   | pnpm add <pkg>    |
| npm uninstall <pkg> | pnpm remove <pkg> |
| npm run <cmd>       | pnpm <cmd>        |

另外两个较为重要的命令。

- `pnpm store path`。查看`pnpm`真正和磁盘建立硬连接的目录。
- `pnpm store prune`。裁剪，`store`中一些长时间没有使用的依赖包会被这个操作擦除掉。可以隔一段时间执行一次，缓解磁盘压力，但是不要执行得太过频繁。