> 我直接现场手写一个webpack

### 写在最前面

关于`webpack`我之前看了很多的文章和视频，结果还是看得迷迷糊糊，被各种繁琐的细节和配置信息整的云里雾里。最后发现得从更加宏观和抽象的视角来看待`webpack`，或者说所有的前端构建工具。

其实官网的图已经给我们解释了`webpack`的作用。

![webpack](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/1/5/16f741d40eaf5b45~tplv-t2oaga2asx-zoom-in-crop-mark:4536:0:0:0.image)

你写的一堆组件啊，`sass less`这种东西浏览器根本不认识，`webpack`的作用就是把这些玩意给你转换成浏览器认识的文件。并且你项目里面各种组件依赖过来依赖过去，数据通信各种乱飞，`webpack`能分析这些依赖关系，把你项目里面的文件给装箱打包成一个或者多个`js`文件。

这里只需要了解`webpack`做了什么就行。总结起来就是**分析依赖，装箱打包**。

## webpack构建流程

1. 初始化参数。从配置文件（`webpack.confgi.js`）和`Shell`语句（比如`npm run build`）中读取合并参数，并得出最终的参数。
2. 开始编译。利用上一步得到的参数初始化`Compiler`对象，加载配置的所有插件，执行`run`方法开始编译。
3. 确定入口：根据配置文件中的`entry`配置找到入口文件。
4. 编译模块。从入口文件开始，调用配置的`loader`处理模块。然后寻找该模块依赖的模块，递归本步骤直到入口文件依赖的所有模块都被处理。
5. 完成编译。上一步之后，得到了经过`loader`处理后的所有模块的内容和他们之间的依赖关系。
6. 输出资源。根据入口文件和模块之间的依赖关系，组成成一个个包含多个模块的`Chunk`，将`Chunk`转换成单独的文件并且添加到输出列表，这是最后一次可以修改输出内容的机会。
7. 完成输出。根据出口`output`配置，将输出资源写入到指定的文件目录下。

在上述整个流程中，`webpack`会在特定的时间广播特定的时间，插件在监听到感兴趣的事件后就会开始执行特定流程。插件能够调用`webpack`提供的`API`改变`webpack`的运行结果。

