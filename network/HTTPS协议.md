> HTTP协议的加密版本，并非全新的协议。

`HTTP`协议虽然方便快捷，但是存在下面三个缺点。

- `HTTP`协议的报文是明文传输的，存在被窃听的风险。
- `HTTP`协议无法验证通信双方的身份，容易被中间人攻击。
- `HTTP`协议无法验证传输内容的完整性，存在内容被修改的风险。

于是便有了`HTTPS`协议，它是在`HTTP`和`TCP`层之间加入了一个`SSL/TLS`加密层来解决上面的三个问题。

#### 加密报文

`HTTPS`采用对称和非对称加密公用的混合加密方式。真正传输信息的过程使用对称加密，即解密和解密采用的同一个公钥，这样可以提高信息加解密的速度。但是这个公钥一旦被中间人获取就没有加密的意义了。

因此在建立网络连接的时候，传输这个用于通信的公钥的时候，使用非对称加密。加密方使用对方的公钥加密信息，只有对应的私钥才能解开这个加密信息，所以这个公钥即使被别获取了也不用担心，因为没有私钥是无法进行解密的。非对称加密安全，但是加解密的过程比较耗费性能，因此`HTTPS`中仅使用它来传输后续通信时需要使用的公钥。

#### 数字签名

数字签名是防止传输的信息被篡改和替换的。传输内容的时候，计算机会利用**摘要算法**生成内容对应的哈希值，也就是所谓的数组签名，然后利用**私钥加密，公钥解密**的方式将内容和哈希值进行加密，然后将内容和数字签名一并发送。接受方使用公钥对信息进行解密，能够解密成功表示信息没有被篡改过，由此实现传输内容完整有效的验证。

**非对称加密是对内容的哈希值进行加密，而不是对内容本身进行加密**。

#### 数字证书

数字证书是为了验证通信双方的身份而出现的。就是证明我的却是我的一种方式。

服务器的运营商向第三方数字认证机构（`CA`）申请数字证书并且提交自己的公钥。`CA`机构验证申请者身份之后，会给这个公钥一个数字签名（这个数字签名由`CA`的私钥形成），然后将申请者的加上数字签名的公钥放入数字证书发送给申请者。

服务器运营商发送信息时，将数字证书和服务器的公钥一并发送给客户端。由于操作系统中基本都内置了`CA`的公钥，所以可以利用该公钥进行解密，验证数字证书是否是有效的。然后就可以利用服务器发送过来的公钥对信息进行加密然后传输了。

### HTTPS协议的传输过程

1. 客户端发送`Client Hello`到服务器，里面包含客户端支持的`SSL`版本，随机值`Random1`，以及使用的加密算法和秘钥长度。
2. 服务器接受到之后。发送`Server Hello`信息，包含服务器的`SSL`版本，随机值`Random2`以及加密算法和秘钥长度。
3. 紧接着服务器发送`Certificate`报文，其中包含服务器的公钥和数字证书。
4. 服务器接着发送`Server Hello Done`报文，告知客户端最初的`SSL`协商过程结束。
5. 客户端接收到服务器发送的报文，首先验证数字证书的有效性。验证了数字证书的合法性之后，客户端接着发送`Client Key Exchange`报文，里面包含一个被称为`Pre-master scret`的随机密码串。该报文使用了服务器发送过来的公钥进行加密。
6. 接着客户端继续发送`Change Cipher Spec`报文，告知服务器后续的通信采用`Pre-master scret`秘钥进行加密。
7. 客户端发送`Finished`报文，包含连接至今的所有报文的整体校验值。服务器如果能够成功解密该报文，则说明此次握手协商成功。
8. 服务器发送`Change Cipher Spec`报文
9. 服务器发送`Finished`报文。

当客户端和服务器的`Finished`报文交换完毕之后，`SSL`握手的过程正式结束，此后的通信都会受到`SSL`的保护。之后就是发送`HTTP`请求的过程了。

`SSL`握手有四次。

- 1是第一次握手，客户端把`cilent random`发送给服务器。
- 2 3 4是第二次握手，服务器把`server random`发送给客户端，同时还有数字证书。
- 5 6 7是第三次握手，客户端将`Per-master scrte`经过服务器的公钥加密之后发送给服务器。
- 8 9是最后一次握手，此时两边都有了三个随机字符串，并且`Pre-master`是使用非对称加密传输的，非常安全。之后双方都使用这三个随机字符串进行对称加密通信。